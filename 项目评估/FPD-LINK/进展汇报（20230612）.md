## 总体进展报告内容

- 寄存器分析
- 眼图测试
- 连续丢帧分析
- 第二版试制线本地稳定性测试



## 寄存器分析

### 分析步骤

1. 取流前，采集一份953和954的寄存器值。
2. 在出现连续丢帧后，采集另一份953和954的寄存器值。
3. 对前后采集的两份寄存器值进行对比。（有变化的寄存器值如下）

### 原始数据

953寄存器：

| 变化的寄存器                           | 变化值 | 正常/异常 | 备注                                                         |
| -------------------------------------- | :----- | --------- | ------------------------------------------------------------ |
| LOCAL_GPIO_DATA<br /> (Address 0x0D)   | 48->40 | 正常      | gpio3（连接sensor的pwdn引脚）由高到低                        |
| CSI_ERR_CNT<br />(Address 0x5C)        | 78->00 | 正常      | 0x78是驱动初始化阶段的报错，后续取流时寄存器读取均为0        |
| CSI_ERR_STATUS <br />(Address 0x5D)    | 03->00 | 正常      | 0x03是驱动初始化阶段的报错，后续取流时寄存器读取均为0        |
| CSI_ERR_DLANE01<br />(Address 0x5E)    | e2->00 | 正常      | 0xe2是驱动初始化阶段的报错，后续取流时寄存器读取均为0        |
| CSI_PKT_HDR_VC_ID <br />(Address 0x61) | 00->2a | 正常      | 0x2a来自对当前csi packet header的解析<br />“Virtual Channel ID”是0x00<br />“Data ID”是0x2a |
| PKT_HDR_WC_LSB<br />(Address 0x62)     | 00->c0 | 正常      | 0xc0来自对当前csi packet header的解析<br />“Payload count”是960 |
| PKT_HDR_WC_MSB <br />(Address 0x63)    | 00->03 | 正常      | 0x03来自对当前csi packet header的解析<br />“Payload count”是960 |
| CSI_ECC <br />(Address 0x64)           | 00->15 | 正常      | 0x15来自对当前csi packet header的解析<br />"CSI-2 ECC"是0x15 |
| RESERVED<br />(多个寄存器变化)         |        | 正常      | RESERVED寄存器变化                                           |

954寄存器：

| 变化的寄存器                             | 变化值 | 正常/异常 | 备注                                                         |
| ---------------------------------------- | ------ | --------- | ------------------------------------------------------------ |
| GPIO_PIN_STS <br />(Address 0x0E)        | 04->00 | 正常      | gpio2（pwm）由高到低                                         |
| CSI_TX_ISR <br />(Address 0x37)          | 01->03 | 异常      | IS_CSI_PASS_ERROR报错                                        |
| **RX_PORT_STS1 <br />(Address 0x4D)**    | 13->07 | 异常      | PARITY_ERROR报错                                             |
| **RX_PORT_STS2 <br />(Address 0x4E)**    | 2c->fd | 异常      | 报错的字段：<br />1.LINE_LEN _UNSTABLE<br />2.LINE_LEN_CHG<br />3.FPD3_ENCODE _ERROR<br />4.BUFFER_ERROR（？）<br />5.CSI_ERROR(See the CSI_RX_STS register for details.)<br />6.LINE_CNT_CHG |
| **RX_PAR_ERR_HI <br />(Address 0x55)**   | 00->01 | 异常      |                                                              |
| **RX_PAR_ERR_LO <br />(Address 0x56)**   | 00->41 | 异常      |                                                              |
| LINE_COUNT_HI <br />(Address 0x73)       | 00->02 | 正常      | LINE_COUNT是720                                              |
| LINE_COUNT_LO <br />(Address 0x74)       | 00->d0 | 正常      | LINE_COUNT是720                                              |
| LINE_LEN_1 <br />(Address 0x75)          | 00->03 | 正常      | LINE_LEN是960                                                |
| LINE_LEN_0 <br />(Address 0x76)          | 00->c0 | 正常      | LINE_LEN是960                                                |
| **CSI_RX_STS <br />(Address 0x7A)**      | 02->0e | 异常      | 报错的字段：<br />1.LENGTH_ERR<br />2.CKSUM_ERR<br />3.ECC2_ERR |
| **CSI_ERR_COUNTER <br />(Address 0x7B)** | 15->8d | 异常      |                                                              |
| REFCLK_FREQ <br />(Address 0xA5)         | 18->19 | 正常      |                                                              |

#### 个人分析

953寄存器无报错。

954寄存器报错如下：

- RX_PORT_STS1 (Address 0x4D)  的PARITY_ERROR和RX_PORT_STS2 (Address 0x4E)  报错。
- RX_PAR_ERR_HI (Address 0x55)  和RX_PAR_ERR_LO (Address 0x56)  报错。
- CSI_RX_STS (Address 0x7A)  和CSI_ERR_COUNTER (Address 0x7B)  报错。

#### TI分析

<img src="Y:\github_local\notebook\项目评估\FPD-LINK\.进展汇报（20230612）.assets\image-20230612134416774.png" alt="image-20230612134416774" style="zoom: 200%;" />

#### 对TI分析的跟进

1、please check whether LOCK is stable?

回答：

- 确认了连续丢帧后取得的寄存器0x4D的LOCK_STS是置1状态，且LOCK_STS_CHG一直为0。
- 结论：在取流过程中，“FPD-Link III receiver is locked to incoming data”， 并且“lock status have not been changed”。LOCK is stable。

2、please check the link quality

目前进展：等待眼图数据。



## 眼图测试

**2023年5月12日**，第一版试制线的眼图测试返回的结论如下：

![image-20230612163757184](Y:\github_local\notebook\项目评估\FPD-LINK\.进展汇报（20230612）.assets\image-20230612163757184.png)

**2023年6月12日**会向三期发出第二版试制线眼图测试和降频改进验证的硬件，后续一起进行下面三项测试：

- 第一批试制线抖动的进一步分析。
- 第二批试制线的眼图测试。
- 降频方案硬件验证。



## 连续丢帧分析

### 寄存器监控机制介绍

- 如果触发一次”连续丢3帧“机制，则增加一次信号量；另一个读寄存器的线程会等待此信号量，获得信号量后会读取一遍953和954的寄存器，然后记录到日志中（日志中的时间戳是一轮寄存器读取开始的时间）。
- 目前监控机制存在不健全的地方：由于读取寄存器的时间大概200ms，远大于两帧数据之间的间隔10ms，如果在此轮寄存器读取结束前发生了另一次丢帧，那么信号量就会加1，200ms此轮寄存器读取结束后，就会立即开始进行第二轮寄存器读取和记录工作。

### 原始数据

| 时间段                                             | 连续丢3帧次数 |
| -------------------------------------------------- | ------------- |
| 2023-06-05 20:28:11至2023-06-07 09:08:32（37小时） | 9             |
| 2023-06-07 09:08:32至2023-06-10 03:33:04（66小时） | 2             |

2023-06-05 20:28:11至2023-06-07 09:08:32（37小时）触发”连续丢3帧次数“机制后，寄存器读取开始的时间点：

| 时间点                        | 和上一个时间戳的差值 | 是否是寄存器连续读取的第一次 |
| ----------------------------- | -------------------- | ---------------------------- |
| [2023-06-06 11:27:17:305568]1 |                      | 是（连续一次）               |
| [2023-06-06 11:27:18:258625]2 | 953ms                | 是（连续两次）               |
| [2023-06-06 11:27:18:491191]3 | 233ms                |                              |
| [2023-06-06 14:25:46:984017]4 | 约2小时              | 是（连续两次）               |
| [2023-06-06 14:25:47:218468]5 | 234ms                |                              |
| [2023-06-06 17:22:58:186328]6 | 约3小时              | 是（连续一次）               |
| [2023-06-06 17:22:59:800516]7 | 1614ms               | 是（连续**三次**）           |
| [2023-06-06 17:23:00:034613]8 | 234ms                |                              |
| [2023-06-06 17:23:00:268395]9 | 234ms                |                              |

2023-06-07 09:08:32至2023-06-10 03:33:04（66小时）触发”连续丢3帧次数“机制后，寄存器读取开始的时间点：

| 连续丢3帧的触发时间               | 和上一个时间戳的差值 | 是否是寄存器连续读取的第一次 |
| --------------------------------- | -------------------- | ---------------------------- |
| **[2023-06-08 10:39:57:513279]1** |                      | 是（连续两次）               |
| [2023-06-08 10:39:57:746920]2     | 233ms                |                              |

### 分析

因为监控机制的不健全，我们无法得知”连续丢3帧“是否是连续触发的，自然无法准确得知连续丢帧的最大值是多少。

但是我们可以考虑一种最坏的情况，即如果寄存器连续读取了，那么就是”连续丢3帧“机制连续触发了。那么可以说，最坏情况下，目前监控到的连续丢帧最大值为8帧。



## 第二版试制线本地稳定性测试

本地稳定性测试在王张朋工的位置进行测试，我提供测试软件资源后，由王工负责。

经王工反馈，本地组织了两组对第二版试制线的本地稳定性测试：

- 都运行**64小时**取流。
- **一组未丢帧，一组丢了一帧**。

![image-20230612135955246](Y:\github_local\notebook\项目评估\FPD-LINK\.进展汇报（20230612）.assets\image-20230612135955246.png)

![image-20230612140025325](Y:\github_local\notebook\项目评估\FPD-LINK\.进展汇报（20230612）.assets\image-20230612140025325.png)
